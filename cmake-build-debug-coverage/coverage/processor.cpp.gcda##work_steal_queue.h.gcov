        -:    0:Source:/home/df/Documents/workspace/async_runtime/include/ar/work_steal_queue.h
        -:    0:Graph:/home/df/Documents/workspace/async_runtime/cmake-build-debug-coverage/CMakeFiles/ar.dir/src/processor.cpp.gcno
        -:    0:Data:/home/df/Documents/workspace/async_runtime/cmake-build-debug-coverage/CMakeFiles/ar.dir/src/processor.cpp.gcda
        -:    0:Runs:1
        -:    1:#ifndef AR_WORKSTEALQUEUE_H
        -:    2:#define AR_WORKSTEALQUEUE_H
        -:    3:
        -:    4:
        -:    5:#include "ar/os.hpp"
        -:    6:#include "ar/array.hpp"
        -:    7:
        -:    8:
        -:    9:namespace AsyncRuntime {
        -:   10:
        -:   11:
        -:   12:    /**
        -:   13:     * @class TaskQueue
        -:   14:     * @brief Lock-free unbounded single-producer multiple-consumer queue.
        -:   15:     * @tparam T data type
        -:   16:     */
        -:   17:    template<typename T>
        -:   18:    class WorkStealQueue {
        -:   19:    public:
        -:   20:
        -:   21:        /**
        -:   22:        @brief constructs the queue with a given capacity
        -:   23:        @param capacity the capacity of the queue (must be power of 2)
        -:   24:        */
        -:   25:        explicit WorkStealQueue(int64_t capacity = 1024);
        -:   26:
        -:   27:        /**
        -:   28:        @brief destructs the queue
        -:   29:        */
        -:   30:        ~WorkStealQueue();
        -:   31:
        -:   32:        /**
        -:   33:        @brief queries if the queue is empty at the time of this call
        -:   34:        */
        -:   35:        bool empty() const noexcept;
        -:   36:
        -:   37:        /**
        -:   38:        @brief queries the number of items at the time of this call
        -:   39:        */
        -:   40:        size_t size() const noexcept;
        -:   41:
        -:   42:        /**
        -:   43:        @brief queries the capacity of the queue
        -:   44:        */
        -:   45:        int64_t capacity() const noexcept;
        -:   46:
        -:   47:        /**
        -:   48:        @brief inserts an item to the queue
        -:   49:        Only the owner thread can insert an item to the queue.
        -:   50:        The operation can trigger the queue to resize its capacity
        -:   51:        if more space is required.
        -:   52:        @tparam O data type
        -:   53:        @param item the item to perfect-forward to the queue
        -:   54:        */
        -:   55:        template<typename O>
        -:   56:        void push(O &&item);
        -:   57:
        -:   58:        /**
        -:   59:        @brief pops out an item from the queue
        -:   60:        Only the owner thread can pop out an item from the queue.
        -:   61:        The return can be a @std_nullopt if this operation failed (empty queue).
        -:   62:        */
        -:   63:        std::optional<T> pop();
        -:   64:
        -:   65:        /**
        -:   66:        @brief steals an item from the queue
        -:   67:        Any threads can try to steal an item from the queue.
        -:   68:        The return can be a @std_nullopt if this operation failed (not necessary empty).
        -:   69:        */
        -:   70:        std::optional<T> steal();
        -:   71:
        -:   72:
        -:   73:    private:
        -:   74:        std::atomic<int64_t> _top;
        -:   75:        std::atomic<int64_t> _bottom;
        -:   76:        std::atomic<AtomicArray<T> *> _array;
        -:   77:        std::vector<AtomicArray<T> *> _garbage;
        -:   78:    };
        -:   79:
        -:   80:
        -:   81:    template<typename T>
function _ZN12AsyncRuntime14WorkStealQueueIPNS_4TaskEEC2El called 0 returned 0% blocks executed 0%
    #####:   82:    WorkStealQueue<T>::WorkStealQueue(int64_t c) {
    %%%%%:   82-block  0
call    0 never executed
    #####:   83:        assert(c && (!(c & (c - 1))));
branch  0 never executed
branch  1 never executed
    %%%%%:   83-block  0
branch  2 never executed
branch  3 never executed
    %%%%%:   83-block  1
call    4 never executed
    #####:   84:        _top.store(0, std::memory_order_relaxed);
    %%%%%:   84-block  0
call    0 never executed
    #####:   85:        _bottom.store(0, std::memory_order_relaxed);
    %%%%%:   85-block  0
call    0 never executed
    #####:   86:        _array.store(new AtomicArray<T>{c}, std::memory_order_relaxed);
    %%%%%:   86-block  0
call    0 never executed
branch  1 never executed
branch  2 never executed
    %%%%%:   86-block  1
call    3 never executed
branch  4 never executed
branch  5 never executed
    %%%%%:   86-block  2
call    6 never executed
    $$$$$:   86-block  3
call    7 never executed
    #####:   87:        _garbage.reserve(32);
call    0 never executed
branch  1 never executed
branch  2 never executed
    #####:   88:    }
    %%%%%:   88-block  0
    $$$$$:   88-block  1
call    0 never executed
        -:   89:
        -:   90:
        -:   91:    template<typename T>
function _ZN12AsyncRuntime14WorkStealQueueIPNS_4TaskEED2Ev called 0 returned 0% blocks executed 0%
    #####:   92:    WorkStealQueue<T>::~WorkStealQueue() {
    #####:   93:        for (auto a: _garbage) {
    %%%%%:   93-block  0
call    0 never executed
call    1 never executed
    %%%%%:   93-block  1
call    2 never executed
    %%%%%:   93-block  2
call    3 never executed
    %%%%%:   93-block  3
call    4 never executed
branch  5 never executed
branch  6 never executed
    #####:   94:            delete a;
branch  0 never executed
branch  1 never executed
    %%%%%:   94-block  0
call    2 never executed
call    3 never executed
        -:   95:        }
    #####:   96:        delete _array.load();
    %%%%%:   96-block  0
call    0 never executed
branch  1 never executed
branch  2 never executed
    %%%%%:   96-block  1
call    3 never executed
call    4 never executed
    #####:   97:    }
    %%%%%:   97-block  0
call    0 never executed
        -:   98:
        -:   99:
        -:  100:    template<typename T>
function _ZNK12AsyncRuntime14WorkStealQueueIPNS_4TaskEE5emptyEv called 21 returned 95% blocks executed 100%
       21:  101:    bool WorkStealQueue<T>::empty() const noexcept {
       21:  102:        int64_t b = _bottom.load(std::memory_order_relaxed);
       21:  102-block  0
call    0 returned 21
       21:  103:        int64_t t = _top.load(std::memory_order_relaxed);
       21:  103-block  0
call    0 returned 20
       20:  104:        return b <= t;
       20:  104-block  0
        -:  105:    }
        -:  106:
        -:  107:
        -:  108:    template<typename T>
        -:  109:    size_t WorkStealQueue<T>::size() const noexcept {
        -:  110:        int64_t b = _bottom.load(std::memory_order_relaxed);
        -:  111:        int64_t t = _top.load(std::memory_order_relaxed);
        -:  112:        return static_cast<size_t>(b >= t ? b - t : 0);
        -:  113:    }
        -:  114:
        -:  115:
        -:  116:    template<typename T>
        -:  117:    template<typename O>
function _ZN12AsyncRuntime14WorkStealQueueIPNS_4TaskEE4pushIRS2_EEvOT_ called 0 returned 0% blocks executed 0%
    #####:  118:    void WorkStealQueue<T>::push(O &&o) {
    #####:  119:        int64_t b = _bottom.load(std::memory_order_relaxed);
    %%%%%:  119-block  0
call    0 never executed
    #####:  120:        int64_t t = _top.load(std::memory_order_acquire);
    %%%%%:  120-block  0
call    0 never executed
    #####:  121:        AtomicArray<T> *a = _array.load(std::memory_order_relaxed);
    %%%%%:  121-block  0
call    0 never executed
        -:  122:
        -:  123:        // queue is full
    #####:  124:        if (a->capacity() - 1 < (b - t)) {
call    0 never executed
branch  1 never executed
branch  2 never executed
    #####:  125:            AtomicArray<T> *tmp = a->resize(b, t);
    %%%%%:  125-block  0
call    0 never executed
branch  1 never executed
branch  2 never executed
    #####:  126:            _garbage.push_back(a);
    %%%%%:  126-block  0
call    0 never executed
branch  1 never executed
branch  2 never executed
    #####:  127:            std::swap(a, tmp);
    %%%%%:  127-block  0
call    0 never executed
    #####:  128:            _array.store(a, std::memory_order_relaxed);
call    0 never executed
        -:  129:        }
        -:  130:
    #####:  131:        a->store(b, std::forward<O>(o));
    %%%%%:  131-block  0
call    0 never executed
call    1 never executed
        -:  132:        std::atomic_thread_fence(std::memory_order_release);
    #####:  133:        _bottom.store(b + 1, std::memory_order_relaxed);
    %%%%%:  133-block  0
call    0 never executed
    #####:  134:    }
    %%%%%:  134-block  0
        -:  135:
        -:  136:
        -:  137:    template<typename T>
        -:  138:    std::optional<T> WorkStealQueue<T>::pop() {
        -:  139:        int64_t b = _bottom.load(std::memory_order_relaxed) - 1;
        -:  140:        AtomicArray<T> *a = _array.load(std::memory_order_relaxed);
        -:  141:        _bottom.store(b, std::memory_order_relaxed);
        -:  142:        std::atomic_thread_fence(std::memory_order_seq_cst);
        -:  143:        int64_t t = _top.load(std::memory_order_relaxed);
        -:  144:
        -:  145:        std::optional<T> item;
        -:  146:
        -:  147:        if (t <= b) {
        -:  148:            item = a->load(b);
        -:  149:            if (t == b) {
        -:  150:                // the last item just got stolen
        -:  151:                if (!_top.compare_exchange_strong(t, t + 1,
        -:  152:                                                  std::memory_order_seq_cst,
        -:  153:                                                  std::memory_order_relaxed)) {
        -:  154:                    item = std::nullopt;
        -:  155:                }
        -:  156:                _bottom.store(b + 1, std::memory_order_relaxed);
        -:  157:            }
        -:  158:        } else {
        -:  159:            _bottom.store(b + 1, std::memory_order_relaxed);
        -:  160:        }
        -:  161:
        -:  162:        return item;
        -:  163:    }
        -:  164:
        -:  165:
        -:  166:    template<typename T>
function _ZN12AsyncRuntime14WorkStealQueueIPNS_4TaskEE5stealEv called 43 returned 105% blocks executed 90%
       43:  167:    std::optional<T> WorkStealQueue<T>::steal() {
       87:  168:        int64_t t = _top.load(std::memory_order_acquire);
       43:  168-block  0
call    0 returned 44
       44:  168-block  1
        -:  169:        std::atomic_thread_fence(std::memory_order_seq_cst);
       44:  170:        int64_t b = _bottom.load(std::memory_order_acquire);
       44:  170-block  0
call    0 returned 45
        -:  171:
       45:  172:        std::optional<T> item;
        -:  173:
       45:  174:        if (t < b) {
       45:  174-block  0
branch  0 taken 5 (fallthrough)
branch  1 taken 40
        5:  175:            AtomicArray<T> *a = _array.load(std::memory_order_consume);
        5:  175-block  0
call    0 returned 5
        5:  176:            item = a->load(t);
call    0 returned 5
call    1 returned 5
       10:  177:            if (!_top.compare_exchange_strong(t, t + 1,
call    0 returned 5
        5:  177-block  0
branch  1 taken 0 (fallthrough)
branch  2 taken 5
        -:  178:                                              std::memory_order_seq_cst,
        -:  179:                                              std::memory_order_relaxed)) {
    #####:  180:                return std::nullopt;
    %%%%%:  180-block  0
call    0 never executed
        -:  181:            }
        -:  182:        }
        -:  183:
       45:  184:        return item;
       45:  184-block  0
        -:  185:    }
        -:  186:
        -:  187:
        -:  188:    template<typename T>
        -:  189:    int64_t WorkStealQueue<T>::capacity() const noexcept {
        -:  190:        return _array.load(std::memory_order_relaxed)->capacity();
        -:  191:    }
        -:  192:}
        -:  193:
        -:  194:#endif //AR_WORKSTEALQUEUE_H
